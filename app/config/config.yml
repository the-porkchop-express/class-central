imports:
    - { resource: parameters.yml }
    - { resource: security.yml }

framework:
    #esi:             ~
    #translator:      { fallback: %locale% }
    secret:          %secret%
    router:          { resource: "%kernel.root_dir%/config/routing.yml" }
    form:            true
    csrf_protection: true
    validation:      { enable_annotations: true }
    templating:
      engines: ['twig']
      assets_version: 58
    default_locale: "%locale%"
    trusted_proxies: ~
    session:
      handler_id: session.handler.memcached
    fragments:       ~

# Twig Configuration
twig:
    debug:            %kernel.debug%
    strict_variables: %kernel.debug%
    globals:
      addthis_pubid : %addthis_pubid%
      ganalytics_id : %ganalytics_id%
      fb_admins     : %fb_admins%
      plusPageUrl   : %plusPageurl%
      baseurl       : %baseurl%
      addthisevent  : %addthisevent%
      rackspace_cdn_base_url: %rackspace_cdn_base_url%
      user_session  : @user_session
      user_service  : @user_service
      reviewService : @review
      imageService  : @image_service
      credService   : @credential
      followSrvice  : @follow
      swiftype_engine_key : %swiftype_engine_key%
      clicky_site_id: %clicky_site_id%
      sumo_site_id  : %sumo_site_id%
      inspectlet_id : %inspectlet_id%
      keen_project_id: %keen_project_id%
      keen_write_key:  %keen_write_key%
      segment_write_key: %segment_write_key%
# Assetic Configuration
assetic:
    debug:          %kernel.debug%
    use_controller: false
    bundles:        [ ClassCentralSiteBundle, ClassCentralCredentialBundle ]
    # java: /usr/bin/java
    filters:
        cssrewrite: ~
        # closure:
        #     jar: %kernel.root_dir%/java/compiler.jar
        yui_css:
             jar: %kernel.root_dir%/Resources/java/yuicompressor-2.4.7.jar
        yui_js:
             jar: %kernel.root_dir%/Resources/java/yuicompressor-2.4.7.jar

        lessphp:
          apply_to: "\.less$"
          formatter: "compressed"
          preserve_comments: false
    assets:
      bootstrap_css:
          inputs:
              - %kernel.root_dir%/../src/ClassCentral/SiteBundle/Resources/public/slashpixel/less/app.less
          filters:
              - lessphp
      widget_css:
          inputs:
              - %kernel.root_dir%/../src/ClassCentral/SiteBundle/Resources/public/slashpixel/widget/less/main.less
          filters:
              - lessphp
# Doctrine Configuration
doctrine:
    dbal:
        driver:   %database_driver%
        host:     %database_host%
        port:     %database_port%
        dbname:   %database_name%
        user:     %database_user%
        password: %database_password%
        charset:  UTF8

    orm:
        auto_generate_proxy_classes: %kernel.debug%
        auto_mapping: true

keen_io:
      project_id: %keen_user_stats_project_id%
      master_key: %keen_user_stats_master_key%
      write_key:  %keen_user_stats_write_key%
      read_key:   %keen_user_stats_read_key%

# Swiftmailer Configuration
swiftmailer:
    transport: %mailer_transport%
    host:      %mailer_host%
    username:  %mailer_user%
    password:  %mailer_password%
    spool:     { type: memory }

services:
  es_client:
      class: Elasticsearch\Client
      arguments: [ {hosts:['%es_host%'] } ]
  es_courses:
      class: ClassCentral\ElasticSearchBundle\API\Courses
      arguments: [ '@es_client', '%es_index_name%']
  es_credentials:
      class: ClassCentral\ElasticSearchBundle\API\Credentials
      arguments: [ '@es_client', '%es_index_name%']
  es_cp:
      class: ClassCentral\ElasticSearchBundle\API\CoursePaginated
      arguments: [ '@es_client', '%es_index_name%']
      tags:
        - { name: 'monolog.logger', channel: 'review_widget' }
  course_finder:
      class: ClassCentral\ElasticSearchBundle\Finder
      arguments: ['@service_container']
  course_formatter:
      class: ClassCentral\SiteBundle\Services\CourseFormatter
      arguments: ['@service_container']
  course_listing:
      class: ClassCentral\SiteBundle\Services\CourseListing
      arguments: ['@service_container']
  spotlight:
        class: ClassCentral\SiteBundle\Services\Spotlight
        arguments: ['@service_container']
  follow:
        class: ClassCentral\SiteBundle\Services\Follow
        arguments: ['@service_container']
  suggestions:
        class: ClassCentral\SiteBundle\Services\Suggestions
        arguments: ['@service_container']
  # Used to retrive jobs
  es_scheduler:
        class: ClassCentral\ElasticSearchBundle\API\Scheduler
        arguments: [ '@es_client', '%es_scheduler_index_name%']
  scheduler:
      class: ClassCentral\ElasticSearchBundle\Scheduler\ESScheduler
      calls:
        - [setContainer, ['@service_container'] ]
      tags:
        - { name: 'monolog.logger', channel: 'scheduler' }

  es_runner:
        class: ClassCentral\ElasticSearchBundle\Scheduler\ESRunner
        calls:
          - [setContainer, ['@service_container'] ]
  es_indexer:
      class: ClassCentral\ElasticSearchBundle\Indexer
      calls:
          - [setContainer, ['@service_container'] ]

  dom_parser:
    class: SimplehtmldomClient
  doctrine_cache:
    class: Doctrine\Common\Cache\MemcachedCache
    calls:
      - [setMemcached,[ @session.memcached ] ]
  cache:
    class: ClassCentral\SiteBundle\Services\Cache
    calls:
      - [setCache,[ @doctrine_cache ] ]
      - [setCacheKeyPrefix, [%baseurl%] ]
  newsletter:
    class: ClassCentral\SiteBundle\Services\Newsletter
    arguments: ['%mailgun_api_key%', '%mailgun_domain_name%']
  user_session:
    class: ClassCentral\SiteBundle\Services\UserSession
    arguments: ['@security.context', '@doctrine', '@session', '@service_container']
    tags:
      - { name: 'kernel.event_listener', event: 'security.interactive_login' }
      - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }
  user_service:
    class: ClassCentral\SiteBundle\Services\User
    arguments: ['@service_container']
  verification_token:
    class: ClassCentral\SiteBundle\Services\VerificationToken
    arguments: ['@doctrine']
  filter:
      class: ClassCentral\SiteBundle\Services\Filter
      arguments: ['@service_container']
  review:
        class: ClassCentral\SiteBundle\Services\Review
        arguments: ['@service_container']
  tag:
        class: ClassCentral\SiteBundle\Services\Tag
        arguments: ['@service_container']
  mooc_report:
        class: ClassCentral\SiteBundle\Services\MOOCReport
        arguments: ['@service_container']
  kuber:
        class: ClassCentral\SiteBundle\Services\Kuber
        arguments: ['@service_container','%kuber_aws_access_key%','%kuber_aws_access_secret%','%kuber_bucket_name%','%kuber_base_url%']
  text_summarizer:
        class: ClassCentral\SiteBundle\Services\TextSummarizer
        arguments: [ '%mashape_api_key%' ]
  image_service:
        class: ClassCentral\SiteBundle\Services\Image
        arguments: [ '@service_container', '%embedly_api_key%' ]
  credential:
        class: ClassCentral\CredentialBundle\Services\Credential
        arguments: ['@service_container']
  # elastic serach indexer
  es_indexer:
        class: ClassCentral\ElasticSearchBundle\Indexer
        calls:
          - [setContainer, ['@service_container'] ]
  slack_client:
         class: Maknz\Slack\Client
         arguments: ['%slack_webhook%']
  session.memcached:
    class: Memcached
    arguments:
    persistent_id: %baseurl%
    calls:
      - [ addServer, [ %session_memcached_host%, %session_memcached_port% ]]
  session.handler.memcached:
    class: Symfony\Component\HttpFoundation\Session\Storage\Handler\MemcachedSessionHandler
    arguments: [@session.memcached, { prefix: %baseurl%, expiretime: %session_memcached_expire% }]
  keen:
     class: ClassCentral\SiteBundle\Services\Keen
     arguments: [ '@service_container' ]

